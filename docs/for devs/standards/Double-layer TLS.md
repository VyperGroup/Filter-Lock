# Double-layer TLS

The tokens also can't be intercepted now by network filters because every part of the response is E2EE, being a [derived message from a shared secret in a web-](https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/deriveKey) that gets decrypted and transformed in the SW. In the SW, the private key should be generated using WebCrypto and stored in IndexedDB because cookies can be intercepted. I recommend using AES-GCM with 128 bits for the private keys and ECDH with a P-256 curve for the key-agreement algorithm. Please do not conform to the NSA's recommandations for Elliptic Curve Cryptography. I highly recommend using the WebCrypto API. Keep in mind that this is the same kind of encryption that TLS 1.3 uses, and it is native to JS on the web.

It is ensured that the tokens cannot be intercepted by network filters, as every part of the response is now encrypted using End-to-End Encryption (E2EE), with the response being a derived message generated by the SubtleCrypto API. This derived message is then decrypted and transformed within the Service Worker (SW). In the SW, a private key is generated using WebCrypto and stored in IndexedDB, as cookies can be intercepted. It is highly recommended to use AES-GCM with 128 bits for the private keys and the web0. It is worth noting that this encryption is of the same standard as TLS 1.3 and is native to JS on the web.

- In most cases, [Resource Tunneling](./Resource%20Tunneling.md) and is the better option, but if you don't have access to a wisp server for some reason, this is the next best thing. Unlike Resource Tunneling, however, this method is undetectable.

- This is an optional feature, because it adds overhead, and there is an alternative.

## Why is TLS not enough?

The filtering extensions continue to be granted access by the browser and by the network filters, resulting in their ability to still view the response. Network filters can either install a custom CA on the user's system, enabling them to alter the certificates to something they can decrypt, or they can read the handshake and block the destination before the rest of the encryption takes place.

> TLDR; TLS certaintly is good for its purpose, but it doesn't not factor in network filtering, because it wasn't made for that.
